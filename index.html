<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Masti Racer | Sunset Arcade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Exo+2:ital,wght@0,300;0,500;0,700;0,900;1,300&family=Rajdhani:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            /* Sunset Theme Colors */
            --primary: #fb923c; /* Orange 400 */
            --accent: #c026d3;  /* Fuchsia 600 */
            --dark: #2e1065;    /* Violet 950 */
            --glass: rgba(46, 16, 101, 0.7);
        }
        
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: var(--dark);
            color: white;
            overflow: hidden;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        #canvas-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100vh;
            z-index: 0;
        }

        /* --- UI LAYOUTS --- */
        #main-menu {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(251, 146, 60, 0.3), rgba(46, 16, 101, 0.9));
            transition: opacity 0.5s ease;
        }

        #game-ui, #game-over-screen {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        #game-ui { z-index: 30; pointer-events: none; }
        #game-over-screen { background: rgba(0,0,0,0.9); z-index: 40; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }

        h1 {
            font-family: 'Bangers', cursive;
            font-weight: 400; 
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 4px 4px 0px var(--accent);
            text-align: center;
            line-height: 1;
            transform: skew(-5deg);
        }

        .btn-cartoon {
            position: relative;
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            color: #fff; border: 3px solid #fff;
            font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.8rem;
            text-transform: uppercase; letter-spacing: 2px;
            padding: 1rem 4rem; transform: skew(-10deg);
            box-shadow: 0px 10px 0px #701a75; transition: all 0.1s ease;
            cursor: pointer; pointer-events: auto;
            white-space: nowrap;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        .btn-cartoon:hover { transform: skew(-10deg) translate(0, 2px); box-shadow: 0px 8px 0px #701a75; filter: brightness(1.1); }
        .btn-cartoon:active { transform: skew(-10deg) translate(0, 10px); box-shadow: 0px 0px 0px #701a75; }
        .btn-cartoon:disabled { background: #555; color: #aaa; border-color: #777; cursor: not-allowed; box-shadow: none; transform: skew(-10deg); }

        .car-selector {
            display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;
            background: var(--glass); padding: 1.5rem; border-radius: 20px; border: 2px solid var(--primary);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .arrow-btn {
            background: var(--primary); border: none; color: white;
            width: 50px; height: 50px; border-radius: 50%;
            font-weight: bold; font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; pointer-events: auto;
            box-shadow: 0 4px 0 var(--accent);
        }
        .arrow-btn:active { transform: translateY(4px); box-shadow: none; }

        .car-info { text-align: center; min-width: 220px; }
        .car-name { font-size: 2rem; font-family: 'Bangers'; color: #fcd34d; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 0 #000; }
        .car-status { font-size: 1rem; letter-spacing: 1px; margin-top: 0.5rem; font-weight: bold; font-family: 'Rajdhani'; }
        .status-locked { color: #ef4444; }
        .status-unlocked { color: #4ade80; }

        .hud-panel {
            position: absolute; background: rgba(0,0,0,0.6); border: 2px solid var(--primary);
            padding: 0.5rem 1rem; border-radius: 12px; font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase; box-shadow: 0 0 15px rgba(251, 146, 60, 0.3);
            backdrop-filter: blur(4px);
        }
        
        /* Central Speedometer */
        .speed-box { 
            top: 20px; left: 50%; transform: translateX(-50%); 
            text-align: center; 
            border-bottom: 4px solid var(--accent);
            padding: 0.5rem 2rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.4));
        }
        .speed-value { font-size: 3rem; line-height: 1; font-weight: 900; color: white; text-shadow: 0 0 10px var(--primary); }
        .speed-label { font-size: 0.8rem; letter-spacing: 2px; color: var(--primary); }

        .score-box { top: 20px; right: 20px; text-align: right; border-color: #facc15; }
        .high-score-box { top: 20px; left: 20px; text-align: left; border-color: #facc15; }

        /* --- MOBILE CONTROLS --- */
        .mobile-controls {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 40px;
            pointer-events: none; z-index: 50;
        }
        
        .control-btn {
            width: 90px; height: 90px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; backdrop-filter: blur(4px);
            transition: transform 0.1s, background 0.1s;
            touch-action: manipulation;
        }
        .control-btn svg { width: 50px; height: 50px; fill: white; opacity: 0.8; }
        .control-btn:active { background: var(--primary); transform: scale(0.9); border-color: white; }
        
        #touch-left, #touch-right { position: absolute; top: 0; height: 100%; width: 50%; z-index: 25; pointer-events: auto; }
        #touch-left { left: 0; } #touch-right { right: 0; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="main-menu">
        <h1 class="text-7xl md:text-9xl mb-2 text-white">MASTI <span class="text-orange-500 block md:inline">RACER</span></h1>
        <div class="text-xl md:text-2xl text-purple-300 font-bold mb-8 font-mono tracking-widest">SUNSET EDITION</div>
        
        <div class="mb-6 text-center bg-black/40 p-4 rounded-xl border border-white/20">
            <div class="text-yellow-400 font-bold tracking-widest text-sm md:text-lg">HIGH SCORE</div>
            <div class="text-5xl font-black text-white font-mono" id="menu-high-score">0</div>
        </div>

        <div class="car-selector">
            <button class="arrow-btn" onclick="changeCar(-1)">&#8592;</button>
            <div class="car-info">
                <div id="ui-car-name" class="car-name">Maruti 800</div>
                <div id="ui-car-status" class="car-status status-unlocked">UNLOCKED</div>
            </div>
            <button class="arrow-btn" onclick="changeCar(1)">&#8594;</button>
        </div>

        <button id="start-btn" class="btn-cartoon mb-8" onclick="startGame()">RACE NOW</button>
        
        <div class="flex gap-4 md:gap-8 text-sm text-gray-300 font-mono">
            <div class="flex flex-col items-center"><span class="text-orange-400 font-bold text-lg">CONTROLS</span><span>A / D or ARROWS</span></div>
        </div>
    </div>

    <div id="game-ui">
        <div class="hud-panel speed-box">
            <div class="speed-value" id="speed-meter">0</div>
            <div class="speed-label">KM/H</div>
        </div>

        <div class="hud-panel high-score-box">
            <div class="text-xs text-gray-300">BEST</div>
            <div class="text-xl font-bold text-yellow-400" id="hud-high-score">0</div>
        </div>
        <div class="hud-panel score-box">
            <div class="text-xs text-gray-300">SCORE</div>
            <div class="text-4xl font-bold text-white" id="score-display">0</div>
        </div>
        
        <div class="mobile-controls md:hidden">
            <button id="btn-left" class="control-btn" aria-label="Steer Left">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <button id="btn-right" class="control-btn" aria-label="Steer Right">
                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
        </div>
        
        <div id="touch-left" class="md:hidden"></div>
        <div id="touch-right" class="md:hidden"></div>
    </div>

    <div id="game-over-screen">
        <h2 class="text-7xl md:text-9xl font-black italic text-red-500 mb-2" style="text-shadow: 4px 4px 0 #fff; font-family: 'Bangers'">CRASHED!</h2>
        <div class="text-4xl text-white mb-8 font-mono font-bold">SCORE: <span id="final-score" class="text-yellow-400">0</span></div>
        <button class="btn-cartoon" onclick="resetGame()">RACE AGAIN</button>
        <button class="text-gray-400 hover:text-white underline mt-8 cursor-pointer z-50 pointer-events-auto font-bold tracking-wider" onclick="stopGame()">BACK TO GARAGE</button>
    </div>

    <audio id="fire-hit-sound" src="makabhosda_aag.mp3" preload="auto"></audio>
    <audio id="score-sound" src="anime-ahh.mp3" preload="auto"></audio>
    <audio id="crash-sound" src="fahhhhh.mp3" preload="auto"></audio>
    <audio id="bg-music" src="11111111.mp3" loop preload="auto"></audio>

    <script>
        // --- CONFIG & STATE ---
        // 10 CARS with Indian context & Unlock System
        const CARS = [
            { id: 'c1', name: 'Nano X', color: 0xfacc15, unlockScore: 0, type: 'hatch' },
            { id: 'c2', name: 'Alto 800', color: 0xef4444, unlockScore: 500, type: 'hatch' },
            { id: 'c3', name: 'Swift Z', color: 0x3b82f6, unlockScore: 1000, type: 'hatch' },
            { id: 'c4', name: 'City V', color: 0xffffff, unlockScore: 2000, type: 'sedan' },
            { id: 'c5', name: 'Thar 4x4', color: 0x111111, unlockScore: 3500, type: 'suv' },
            { id: 'c6', name: 'Scorpio', color: 0xffffff, unlockScore: 5000, type: 'suv' },
            { id: 'c7', name: 'Fortuner', color: 0x000000, unlockScore: 7500, type: 'suv' },
            { id: 'c8', name: 'Mustang GT', color: 0x2563eb, unlockScore: 10000, type: 'sport' },
            { id: 'c9', name: 'Lambo', color: 0x10b981, unlockScore: 15000, type: 'hyper' },
            { id: 'c10', name: 'Batmobile', color: 0x000000, unlockScore: 25000, type: 'hyper' }
        ];

        let state = {
            gameActive: false,
            isGameOver: false,
            score: 0,
            highScore: parseInt(localStorage.getItem('masti_highscore')) || 0,
            speed: 100 / 300,
            selectedCarIndex: 0,
            lastSpawnZ: -20
        };

        let scene, camera, renderer, carGroup, roadGroup, shapesGroup, sceneryGroup;
        let collidables = []; 
        let sceneryCollidables = []; 
        let wheels = [];
        const keys = { a: false, d: false, ArrowLeft: false, ArrowRight: false };

        // --- INIT ---
        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            
            // SUNSET FOG & BACKGROUND
            const fogColor = 0x4a185c; // Deep purple fog
            scene.fog = new THREE.Fog(fogColor, 20, 90);
            scene.background = new THREE.Color(fogColor);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.BasicShadowMap;
            container.appendChild(renderer.domElement);

            // SUNSET LIGHTING
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            
            // Warm orange sun light
            const dl = new THREE.DirectionalLight(0xffaa33, 1.2); 
            dl.position.set(20, 30, 10);
            dl.castShadow = true;
            dl.shadow.mapSize.set(1024, 1024); 
            scene.add(dl);
            
            // Purple Rim light
            const rimLight = new THREE.SpotLight(0xd946ef, 8);
            rimLight.position.set(-10, 5, -5);
            rimLight.lookAt(0,0,0);
            scene.add(rimLight);
            
            // Groups
            shapesGroup = new THREE.Group(); scene.add(shapesGroup);
            sceneryGroup = new THREE.Group(); scene.add(sceneryGroup);
            roadGroup = new THREE.Group(); scene.add(roadGroup);
            
            createRealisticRoad();
            createMenuBackground();
            loadCar(state.selectedCarIndex);
            updateUI();

            camera.position.set(3, 2.5, 6);
            camera.lookAt(0, 0.5, 0);

            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const time = clock.getElapsedTime();
                
                if(!state.gameActive) {
                    if(carGroup) {
                        carGroup.position.set(0, Math.sin(time*1.5)*0.05, 0);
                        carGroup.rotation.y = -Math.PI/6 + Math.sin(time*0.5)*0.1;
                        
                        // Menu rotation
                        shapesGroup.rotation.y += 0.002;
                        shapesGroup.children.forEach((child, i) => {
                            child.rotation.x += 0.01;
                            child.position.y += Math.sin(time + i) * 0.01;
                        });
                    }
                } else if(!state.isGameOver) {
                    updatePhysics(time);
                }
                renderer.render(scene, camera);
            };
            animate();
        }

        // --- 10 CAR MODELS ---
        function loadCar(index) {
            if(carGroup) scene.remove(carGroup);
            wheels = [];
            const config = CARS[index];
            carGroup = buildCarModel(config);
            scene.add(carGroup);
        }

        function buildCarModel(config) {
            const group = new THREE.Group();
            
            // Materials
            const matBody = new THREE.MeshStandardMaterial({ color: config.color, metalness: 0.6, roughness: 0.3 });
            const matBlack = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8 }); // Bumpers/Trim
            const matCarbon = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.5, roughness: 0.5 });
            const matGlass = new THREE.MeshPhysicalMaterial({ color: 0x000000, metalness: 0.9, roughness: 0.1, transparent: true, opacity: 0.8 });
            const matWhite = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const matRed = new THREE.MeshBasicMaterial({ color: 0xff0000 });

            let wheelY = 0.35;
            let wheelZ = 1.3;
            
            // Geometry Logic
            if (config.type === 'hatch') {
                // Small, boxy (Nano/Alto)
                const chassis = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.5, 3.2), matBody);
                chassis.position.y = 0.5; chassis.castShadow = true; group.add(chassis);
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.7, 1.8), matGlass);
                cabin.position.set(0, 1.1, 0.2); group.add(cabin);
                wheelZ = 1.1; wheelY = 0.35;
                addLights(group, 1.6, 1.6, 0.6, matWhite, matRed);

            } else if (config.type === 'sedan') {
                // Standard Sedan (City)
                const chassis = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.5, 4.5), matBody);
                chassis.position.y = 0.5; chassis.castShadow = true; group.add(chassis);
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.6, 2.2), matGlass);
                cabin.position.set(0, 1.0, 0.2); group.add(cabin);
                const hood = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.1, 1.2), matBody);
                hood.position.set(0, 0.76, -1.5); group.add(hood);
                const trunk = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.1, 1.0), matBody);
                trunk.position.set(0, 0.76, 1.9); group.add(trunk);
                wheelZ = 1.5; wheelY = 0.38;
                addLights(group, 1.9, 2.25, 0.6, matWhite, matRed);

            } else if (config.type === 'suv') {
                // Big Boxy (Thar/Scorpio)
                const chassis = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.7, 4.2), matBody);
                chassis.position.y = 0.7; chassis.castShadow = true; group.add(chassis);
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(2.1, 0.7, 2.5), matGlass);
                cabin.position.set(0, 1.4, 0.2); group.add(cabin);
                const grille = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.4, 0.1), matBlack);
                grille.position.set(0, 0.7, -2.15); group.add(grille);
                // Spare wheel
                const spare = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.3, 16), matBlack);
                spare.rotation.x = Math.PI/2; spare.position.set(0, 1.0, 2.15); group.add(spare);
                wheelZ = 1.4; wheelY = 0.55;
                addLights(group, 2.0, 2.1, 0.9, matWhite, matRed);

            } else if (config.type === 'sport') {
                // Sleek (Mustang)
                const chassis = new THREE.Mesh(new THREE.BoxGeometry(2.1, 0.45, 4.6), matBody);
                chassis.position.y = 0.45; chassis.castShadow = true; group.add(chassis);
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.45, 1.8), matGlass);
                cabin.position.set(0, 0.9, 0.3); group.add(cabin);
                const hood = new THREE.Mesh(new THREE.BoxGeometry(1.9, 0.1, 1.6), matBody);
                hood.position.set(0, 0.68, -1.3); group.add(hood);
                // Stripes
                const stripe = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.02, 4.6), matBlack);
                stripe.position.set(0, 0.68, 0); group.add(stripe);
                wheelZ = 1.5; wheelY = 0.4;
                addLights(group, 2.0, 2.3, 0.55, matWhite, matRed);

            } else if (config.type === 'hyper') {
                // Wedge (Lambo/Batmobile)
                const body = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1.8, 4.8, 4), matBody);
                body.rotation.y = Math.PI/4; body.rotation.x = Math.PI/2;
                body.scale.set(1, 0.7, 0.5); body.position.y = 0.5; body.castShadow = true;
                group.add(body);
                // Spoiler
                const wing = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.05, 0.6), matBlack);
                wing.position.set(0, 0.9, 2.0); group.add(wing);
                wheelZ = 1.4; wheelY = 0.4;
                addLights(group, 1.8, 2.3, 0.4, matWhite, matRed);
            }

            // Wheels
            const wheelGeo = new THREE.CylinderGeometry(wheelY, wheelY, 0.3, 16);
            const wheelPos = [ {x: 1.0, z: -wheelZ}, {x: -1.0, z: -wheelZ}, {x: 1.0, z: wheelZ}, {x: -1.0, z: wheelZ} ];

            wheelPos.forEach(p => {
                const w = new THREE.Mesh(wheelGeo, matBlack);
                w.rotation.z = Math.PI/2;
                w.position.set(p.x, wheelY, p.z);
                const rim = new THREE.Mesh(new THREE.CylinderGeometry(wheelY*0.6, wheelY*0.6, 0.31, 8), matCarbon);
                rim.rotation.z = Math.PI/2;
                rim.position.set(p.x, wheelY, p.z);
                group.add(w); group.add(rim);
                wheels.push(w); wheels.push(rim);
            });

            return group;
        }

        function addLights(group, w, l, y, matW, matR) {
            const geo = new THREE.BoxGeometry(0.4, 0.2, 0.1);
            const fl = new THREE.Mesh(geo, matW); fl.position.set(w/2 - 0.4, y, -l); group.add(fl);
            const fr = new THREE.Mesh(geo, matW); fr.position.set(-w/2 + 0.4, y, -l); group.add(fr);
            const bl = new THREE.Mesh(geo, matR); bl.position.set(w/2 - 0.4, y, l); group.add(bl);
            const br = new THREE.Mesh(geo, matR); br.position.set(-w/2 + 0.4, y, l); group.add(br);
        }

        // --- GAME LOGIC ---
        function updatePhysics(time) {
            carGroup.position.z -= state.speed;

            // Smooth Steer
            const steerSpeed = 0.4;
            if(keys.a || keys.ArrowLeft) {
                carGroup.position.x -= steerSpeed;
                carGroup.rotation.y = 0.15; carGroup.rotation.z = 0.05;
            } else if(keys.d || keys.ArrowRight) {
                carGroup.position.x += steerSpeed;
                carGroup.rotation.y = -0.15; carGroup.rotation.z = -0.05;
            } else {
                carGroup.rotation.y *= 0.8; carGroup.rotation.z *= 0.8;
            }
            // Clamp to 3 lane width (approx -5 to 5)
            carGroup.position.x = Math.max(-5.5, Math.min(5.5, carGroup.position.x));

            // Infinite Road
            const gridSnap = Math.floor(carGroup.position.z / 20) * 20;
            roadGroup.position.z = gridSnap + 50;

            // Spawning Logic
            if (carGroup.position.z < state.lastSpawnZ + 10) {
                state.lastSpawnZ -= 20;
                spawnObstacles(state.lastSpawnZ);
                spawnSideElements(state.lastSpawnZ);
            }

            checkCollisions(time);

            // Dynamic Camera
            camera.position.z = carGroup.position.z + 9;
            camera.position.y = 5;
            camera.position.x = carGroup.position.x * 0.5; // slight follow
            camera.lookAt(carGroup.position.x, 0, carGroup.position.z - 10);

            wheels.forEach(w => w.rotation.x -= state.speed * 1.5);
            
            // HUD
            document.getElementById('speed-meter').innerText = Math.floor(state.speed * 300);
        }

        function createRealisticRoad() {
            // 3 Lane Asphalt (Width 14)
            const asphaltMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.9 });
            const road = new THREE.Mesh(new THREE.PlaneGeometry(14, 200), asphaltMat);
            road.rotation.x = -Math.PI/2;
            road.position.y = 0;
            road.receiveShadow = true;
            roadGroup.add(road);

            // Lane Markers (Dashed White)
            // Left Line: -2.33, Right Line: 2.33 (Splitting 14 width into 3 sections roughly 4.6 each)
            const lineGeo = new THREE.PlaneGeometry(0.15, 4);
            const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            
            for(let i=0; i<40; i++) { // 200m length / 5m spacing
                const z = -100 + (i * 8);
                const l1 = new THREE.Mesh(lineGeo, lineMat);
                l1.rotation.x = -Math.PI/2;
                l1.position.set(-2.3, 0.02, z);
                roadGroup.add(l1);

                const l2 = new THREE.Mesh(lineGeo, lineMat);
                l2.rotation.x = -Math.PI/2;
                l2.position.set(2.3, 0.02, z);
                roadGroup.add(l2);
            }

            // Solid Edge Lines
            const edgeGeo = new THREE.PlaneGeometry(0.2, 200);
            const edgeL = new THREE.Mesh(edgeGeo, lineMat);
            edgeL.rotation.x = -Math.PI/2; edgeL.position.set(-6.8, 0.02, 0);
            roadGroup.add(edgeL);
            const edgeR = new THREE.Mesh(edgeGeo, lineMat);
            edgeR.rotation.x = -Math.PI/2; edgeR.position.set(6.8, 0.02, 0);
            roadGroup.add(edgeR);
        }

        function spawnObstacles(z) {
            // 3 Lanes Centers: -4.6, 0, 4.6
            const lanes = [-4.6, 0, 4.6];
            const laneIndex = Math.floor(Math.random() * 3);
            const x = lanes[laneIndex];
            
            const type = Math.random() > 0.4 ? 'fire' : 'berry';
            if(type === 'fire') createFire(x, z);
            else createStrawberry(x, z);
            
            // Chance for double spawn
            if(Math.random() > 0.5) {
                const lane2Index = (laneIndex + 1) % 3;
                createStrawberry(lanes[lane2Index], z);
            }
        }

        function createStrawberry(x, z) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.ConeGeometry(0.6, 1.1, 8), new THREE.MeshToonMaterial({ color: 0xd90429 }));
            body.rotation.x = Math.PI;
            group.add(body);
            const leaf = new THREE.Mesh(new THREE.ConeGeometry(0.7, 0.3, 5), new THREE.MeshToonMaterial({ color: 0x16a34a }));
            leaf.position.y = 0.55;
            group.add(leaf);
            group.position.set(x, 1.5, z);
            group.children.forEach(m => m.castShadow = true);
            scene.add(group);
            collidables.push({ mesh: group, type: 'berry', active: true });
        }

        function createFire(x, z) {
            const group = new THREE.Group();
            for(let i=0; i<5; i++) {
                const h = 1.2 + Math.random();
                const mat = new THREE.MeshBasicMaterial({ color: Math.random()>0.5 ? 0xf97316 : 0xfacc15 });
                const m = new THREE.Mesh(new THREE.ConeGeometry(0.3, h, 4), mat);
                m.position.set((Math.random()-0.5), h/2, (Math.random()-0.5));
                m.userData = { offset: Math.random() * 10 };
                group.add(m);
            }
            group.position.set(x, 0, z);
            scene.add(group);
            collidables.push({ mesh: group, type: 'fire', active: true });
        }

        function spawnSideElements(z) {
            // Dense Vegetation & Scenery
            // Left side (-10 to -30), Right side (10 to 30)
            const count = 3 + Math.floor(Math.random()*3); // 3 to 5 items per row
            
            for(let i=0; i<count; i++) {
                const offsetZ = (Math.random() * 20);
                // Left
                createVegetation(-10 - Math.random()*20, z + offsetZ);
                // Right
                createVegetation(10 + Math.random()*20, z + offsetZ);
            }
        }

        function createVegetation(x, z) {
            const type = Math.random();
            let mesh;
            
            if(type < 0.4) { // Palm Tree
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 4, 6), new THREE.MeshToonMaterial({color: 0x5d4037}));
                trunk.position.y = 2;
                const top = new THREE.Mesh(new THREE.ConeGeometry(2.5, 2, 7), new THREE.MeshToonMaterial({color: 0x15803d}));
                top.position.y = 4;
                mesh = new THREE.Group(); mesh.add(trunk); mesh.add(top);
            } else if (type < 0.7) { // Rock
                const s = 1 + Math.random()*2;
                mesh = new THREE.Mesh(new THREE.DodecahedronGeometry(s, 0), new THREE.MeshToonMaterial({color: 0x475569}));
                mesh.position.y = s/2;
            } else { // Bush
                mesh = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshToonMaterial({color: 0x22c55e}));
                mesh.position.y = 0.75;
            }
            mesh.position.set(x, 0, z);
            sceneryGroup.add(mesh);
            sceneryCollidables.push(mesh);
        }

        function createMenuBackground() {
            const mat = new THREE.MeshToonMaterial({color: 0xc026d3, transparent: true, opacity: 0.5});
            const geo = new THREE.IcosahedronGeometry(1.5);
            for(let i=0; i<30; i++) {
                const m = new THREE.Mesh(geo, mat);
                m.position.set((Math.random()-0.5)*80, (Math.random()-0.5)*40 + 10, (Math.random()-0.5)*60);
                shapesGroup.add(m);
            }
        }

        function checkCollisions(time) {
            const carPos = carGroup.position;
            for(let i = collidables.length - 1; i >= 0; i--) {
                const obj = collidables[i];
                if(!obj.active) continue;

                if(obj.type === 'berry') {
                    obj.mesh.rotation.y += 0.05;
                    obj.mesh.position.y = 1.5 + Math.sin(time * 5) * 0.2;
                }
                if(obj.type === 'fire') {
                    obj.mesh.children.forEach(c => c.scale.y = 1 + Math.sin(time*15 + c.userData.offset)*0.3);
                }

                if(obj.mesh.position.distanceTo(carPos) < 2.8) {
                    if(obj.type === 'fire') gameOver();
                    else collectPoints(obj, i);
                }

                if(obj.mesh.position.z > carPos.z + 10) {
                    scene.remove(obj.mesh); obj.active = false; collidables.splice(i, 1); 
                }
            }
            // Scenery cleanup
            for(let i = sceneryCollidables.length - 1; i >= 0; i--) {
                const s = sceneryCollidables[i];
                if(s.position.z > carPos.z + 20) { sceneryGroup.remove(s); sceneryCollidables.splice(i, 1); }
            }
        }

        function collectPoints(obj, index) {
            obj.active = false;
            scene.remove(obj.mesh);
            collidables.splice(index, 1);
            state.score += 100;
            state.speed += (1 / 300);
            document.getElementById('score-display').innerText = state.score;
            playSound('score-sound');
        }

        function gameOver() {
            state.isGameOver = true;
            document.getElementById('bg-music').pause();
            playSound('fire-hit-sound');
            setTimeout(() => playSound('crash-sound'), 100);
            
            if(state.score > state.highScore) {
                state.highScore = state.score;
                localStorage.setItem('masti_highscore', state.score);
            }
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('game-over-screen').style.display = 'flex';
            document.getElementById('game-ui').style.display = 'none';
        }

        // --- UI FUNCTIONS ---
        window.changeCar = (dir) => {
            let newIndex = state.selectedCarIndex + dir;
            if(newIndex < 0) newIndex = CARS.length - 1;
            if(newIndex >= CARS.length) newIndex = 0;
            state.selectedCarIndex = newIndex;
            updateUI();
            loadCar(newIndex);
        };

        function updateUI() {
            const car = CARS[state.selectedCarIndex];
            document.getElementById('ui-car-name').innerText = car.name;
            document.getElementById('menu-high-score').innerText = state.highScore;
            
            const btn = document.getElementById('start-btn');
            const statusEl = document.getElementById('ui-car-status');
            
            if(state.highScore >= car.unlockScore) {
                statusEl.innerText = "UNLOCKED";
                statusEl.className = "car-status status-unlocked";
                btn.disabled = false;
                btn.innerText = "RACE NOW";
                btn.style.opacity = "1";
            } else {
                statusEl.innerText = `LOCKED (${car.unlockScore} pts)`;
                statusEl.className = "car-status status-locked";
                btn.disabled = true;
                btn.innerText = "LOCKED";
                btn.style.opacity = "0.5";
            }
        }

        window.startGame = () => {
            state.gameActive = true;
            state.isGameOver = false;
            state.score = 0;
            state.speed = 100 / 300;
            document.getElementById('score-display').innerText = '0';
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('game-over-screen').style.display = 'none';
            shapesGroup.visible = false;
            
            const bgMusic = document.getElementById('bg-music');
            bgMusic.currentTime = 0; bgMusic.volume = 0.5; bgMusic.play().catch(()=>{});

            carGroup.position.set(0,0,0);
            carGroup.rotation.set(0,0,0);
            state.lastSpawnZ = -20;
            
            collidables.forEach(c => scene.remove(c.mesh)); collidables = [];
            sceneryCollidables.forEach(s => sceneryGroup.remove(s)); sceneryCollidables = [];
        };

        window.resetGame = window.startGame;

        window.stopGame = () => {
            state.gameActive = false;
            document.getElementById('main-menu').style.display = 'flex';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            shapesGroup.visible = true;
            carGroup.position.set(0,0,0);
            document.getElementById('bg-music').pause();
            updateUI();
        };

        function playSound(id) {
            const s = document.getElementById(id);
            if(s) { s.currentTime=0; s.play().catch(()=>{}); }
        }

        // Inputs
        window.addEventListener('keydown', e => {
            if(e.key === 'a' || e.key === 'ArrowLeft') keys.a = true;
            if(e.key === 'd' || e.key === 'ArrowRight') keys.d = true;
            if(state.isGameOver && e.key === 'Enter') resetGame();
        });
        window.addEventListener('keyup', e => {
            if(e.key === 'a' || e.key === 'ArrowLeft') keys.a = false;
            if(e.key === 'd' || e.key === 'ArrowRight') keys.d = false;
        });

        const handleLeftDown = (e) => { e.preventDefault(); keys.a = true; };
        const handleLeftUp = (e) => { e.preventDefault(); keys.a = false; };
        const handleRightDown = (e) => { e.preventDefault(); keys.d = true; };
        const handleRightUp = (e) => { e.preventDefault(); keys.d = false; };

        document.getElementById('btn-left').addEventListener('touchstart', handleLeftDown);
        document.getElementById('btn-left').addEventListener('touchend', handleLeftUp);
        document.getElementById('btn-right').addEventListener('touchstart', handleRightDown);
        document.getElementById('btn-right').addEventListener('touchend', handleRightUp);
        document.getElementById('touch-left').addEventListener('touchstart', handleLeftDown);
        document.getElementById('touch-left').addEventListener('touchend', handleLeftUp);
        document.getElementById('touch-right').addEventListener('touchstart', handleRightDown);
        document.getElementById('touch-right').addEventListener('touchend', handleRightUp);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
